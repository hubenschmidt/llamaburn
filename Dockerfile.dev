# syntax=docker/dockerfile:1
# Shared builder stage
FROM docker.io/library/rust:1.92-slim-bookworm AS builder

WORKDIR /app

RUN apt-get update && apt-get install -y pkg-config libssl-dev curl && rm -rf /var/lib/apt/lists/*

# Install trunk and wasm target
RUN curl -L https://github.com/trunk-rs/trunk/releases/download/v0.21.14/trunk-x86_64-unknown-linux-gnu.tar.gz | tar xzf - -C /usr/local/bin
RUN rustup target add wasm32-unknown-unknown

COPY agent/Cargo.toml agent/Cargo.lock* ./agent/
COPY agent/crates ./agent/crates

WORKDIR /app/agent

# Build all targets with cache mounts
RUN --mount=type=cache,target=/usr/local/cargo/registry \
    --mount=type=cache,target=/usr/local/cargo/git \
    --mount=type=cache,target=/app/agent/target \
    cargo build --release -p llamaburn-cli -p llamaburn-server && \
    cp target/release/llamaburn target/release/llamaburn-server /tmp/

RUN --mount=type=cache,target=/usr/local/cargo/registry \
    --mount=type=cache,target=/usr/local/cargo/git \
    --mount=type=cache,target=/app/agent/target \
    trunk build --release --config crates/llamaburn-web/Trunk.toml

# CLI runtime
FROM docker.io/library/debian:bookworm-slim AS cli
RUN apt-get update && apt-get install -y ca-certificates && rm -rf /var/lib/apt/lists/*
COPY --from=builder /tmp/llamaburn /usr/local/bin/
CMD ["llamaburn"]

# Server runtime
FROM docker.io/library/debian:bookworm-slim AS server
RUN apt-get update && apt-get install -y ca-certificates && rm -rf /var/lib/apt/lists/*
WORKDIR /app
COPY --from=builder /tmp/llamaburn-server /usr/local/bin/
ENV PORT=8000
EXPOSE 8000
CMD ["llamaburn-server"]

# WebUI runtime
FROM docker.io/library/nginx:alpine AS webui
COPY --from=builder /app/agent/crates/llamaburn-web/dist /usr/share/nginx/html
EXPOSE 3001
CMD ["nginx", "-g", "daemon off;"]
