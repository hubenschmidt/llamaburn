services:
  web-ui:
    image: llamaburn-devbase
    pull_policy: never
    depends_on:
      - llamaburn-agent
    working_dir: /app/agent/crates/llamaburn-web
    ports:
      - "3001:3001"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - OLLAMA_HOST=http://host.docker.internal:11434
      - CARGO_HOME=/app/.cargo
      - SCCACHE_DIR=/app/.sccache
    volumes:
      - ./agent:/app/agent
      - cargo-cache:/app/.cargo
      - target-cache:/app/agent/target
      - sccache-cache:/app/.sccache
    command: trunk serve --address 0.0.0.0 --port 3001 --proxy-backend=http://llamaburn-agent:8000/api/

  llamaburn-agent:
    build:
      context: .
      dockerfile: Dockerfile.devbase
    image: llamaburn-devbase
    working_dir: /app/agent
    ports:
      - "8000:8000"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    devices:
      - /dev/kfd:/dev/kfd
      - /dev/dri:/dev/dri
    group_add:
      - "44"
      - "992"
    environment:
      - OLLAMA_HOST=http://host.docker.internal:11434
      - PORT=8000
      - STATIC_DIR=/app/agent/crates/llamaburn-web/dist
      - CARGO_HOME=/app/.cargo
      - SCCACHE_DIR=/app/.sccache
    volumes:
      - ./agent:/app/agent
      - cargo-cache:/app/.cargo
      - target-cache:/app/agent/target
      - sccache-cache:/app/.sccache
    command: cargo watch -x 'run -p llamaburn-server'

  cli:
    build:
      context: .
      dockerfile: Dockerfile.dev
      target: cli
    stdin_open: true
    tty: true
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ./results:/app/results
    environment:
      - OLLAMA_HOST=http://host.docker.internal:11434

volumes:
  cargo-cache:
  target-cache:
  sccache-cache:
